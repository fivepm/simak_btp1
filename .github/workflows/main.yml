on:
  push:
    branches:
      - main
name: ğŸš€ Deploy website on push main
jobs:
  web-deploy:
    name: ğŸ‰ Deploy
    runs-on: ubuntu-latest
    steps:
      - name: ğŸšš Get latest code
        uses: actions/checkout@v4
        with:
          # Kita butuh history untuk membandingkan file
          fetch-depth: 2

      - name: ğŸ” Check for changed files
        # Aksi ini akan memberi tahu kita file apa saja yang berubah
        uses: tj-actions/changed-files@v44
        id: changed_files

      - name: ğŸ“‚ Sync files via FTP
        # Ini adalah langkah FTP Anda yang sekarang, tetap berjalan
        uses: SamKirkland/FTP-Deploy-Action@v4.3.6
        with:
          server: ${{ secrets.ftp_server }}
          username: ${{ secrets.ftp_username }}
          password: ${{ secrets.ftp_password }}
          server-dir: /simak/

      # --- Bagian Baru Anda Dimulai Di Sini ---

      - name: ğŸ“¦ Run Composer Install
        # 'if' ini adalah "pilihan" Anda.
        # Hanya berjalan jika composer.json atau composer.lock berubah.
        if: |
          contains(steps.changed_files.outputs.modified_files, 'composer.json') ||
          contains(steps.changed_files.outputs.modified_files, 'composer.lock')
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            echo "ğŸ”¥ Composer file changed, running install..."
            cd /simak/
            composer install --no-dev --optimize-autoloader

      - name: ğŸ—„ï¸ Run Phinx Migrate
        # 'if' ini adalah "pilihan" Anda.
        # Hanya berjalan jika ada file baru/berubah di folder database/migrations
        if: |
          startsWith(steps.changed_files.outputs.added_files, 'database/migrations/') ||
          startsWith(steps.changed_files.outputs.modified_files, 'database/migrations/')
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            echo "Migrations detected, running Phinx..."
            cd /simak/
            vendor/bin/phinx migrate -e production
