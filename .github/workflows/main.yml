on:
  push:
    branches:
      - main
name: ğŸš€ Deploy website on push main
jobs:
  web-deploy:
    name: ğŸ‰ Deploy
    runs-on: ubuntu-latest
    steps:
      - name: ğŸšš Get latest code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Ubah jadi 0 agar deteksi file lebih akurat

      - name: ğŸ” Check for changed files
        uses: tj-actions/changed-files@v44
        id: changed_files

      - name: ğŸ“‚ Sync files via FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.6
        with:
          server: ${{ secrets.ftp_server }}
          username: ${{ secrets.ftp_username }}
          password: ${{ secrets.ftp_password }}
          server-dir: /simak/

      - name: ğŸ“¦ Run Composer Install
        if: contains(steps.changed_files.outputs.modified_files, 'composer.json') || contains(steps.changed_files.outputs.modified_files, 'composer.lock')
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            echo "ğŸ”¥ Composer file changed, running install..."
            # Masuk ke folder simak di SERVER
            cd simak 
            composer install --no-dev --optimize-autoloader

      - name: ğŸ—„ï¸ Run Phinx Migrate
        if: contains(steps.changed_files.outputs.added_files, 'db/migrations/') || contains(steps.changed_files.outputs.modified_files, 'db/migrations/')
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            echo "Migrations detected, running Phinx..."
            # Masuk ke folder simak di SERVER
            cd simak
            vendor/bin/phinx migrate -e production
